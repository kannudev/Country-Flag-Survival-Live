<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Flag Battle</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        /* --- ANIMATED SPACE BACKGROUND --- */
        body {
            margin: 0; padding: 0; overflow: hidden;
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1e002e, #0f0c29, #302b63);
            background-size: 300% 300%;
            animation: cosmicFlow 20s ease infinite;
            color: white;
        }
        @keyframes cosmicFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        #canvas-container { width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }

        /* --- UI ELEMENTS --- */
        .neon-text {
            text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px #ff00de, 0 0 30px #ff00de;
        }

        /* 1. TOP BAR (Main Title & Counter) */
        #top-ui {
            position: absolute; top: 20px; width: 100%; text-align: center; pointer-events: none; z-index: 10;
        }
        h1 { margin: 0; font-size: 32px; letter-spacing: 2px; color: #fff; text-transform: uppercase; }
        #counter { font-size: 40px; font-weight: 800; color: #00ffea; text-shadow: 0 0 10px #00ffea; margin-top: 5px; }

        /* 2. LEADERBOARD (Top Left) */
        #leaderboard {
            position: absolute; top: 20px; left: 20px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #00ffea;
            border-radius: 10px;
            padding: 15px;
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            pointer-events: auto;
            box-shadow: 0 0 15px rgba(0, 255, 234, 0.3);
            z-index: 20;
        }
        #leaderboard h3 { margin: 0 0 10px 0; color: #ffd700; border-bottom: 1px solid #fff; padding-bottom: 5px; font-size: 18px; }
        .lb-item { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 5px; }
        .lb-score { font-weight: bold; color: #00ffea; }

        /* 3. SURVIVOR TICKER (Top Right Scrolling List) */
        #ticker-box {
            position: absolute; top: 20px; right: 20px; width: 250px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #ff00de;
            border-radius: 10px;
            padding: 10px;
            height: 400px;
            overflow: hidden;
            z-index: 20;
            box-shadow: 0 0 15px rgba(255, 0, 222, 0.3);
        }
        #ticker-header { color: #ff00de; font-weight: bold; text-align: center; border-bottom: 1px solid #fff; margin-bottom: 10px; }
        #ticker-list { list-style: none; padding: 0; margin: 0; text-align: center; }
        .ticker-item { padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 14px; animation: slideIn 0.3s; }

        /* 4. RESTART BUTTON */
        .btn {
            pointer-events: auto; margin-top: 10px; padding: 10px 25px;
            background: linear-gradient(45deg, #ff00de, #00ffea);
            color: #000; font-weight: bold; border: none; border-radius: 20px; cursor: pointer;
            box-shadow: 0 0 10px #ff00de;
        }
        .btn:hover { transform: scale(1.1); }

        /* 5. WINNER SCREEN */
        #winner-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none;
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 100;
        }
        #winner-emoji { font-size: 120px; animation: bounce 1s infinite; }
        #winner-text { font-size: 60px; color: gold; font-weight: 900; text-shadow: 0 0 20px gold; margin: 20px 0; }
        
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
    </style>
</head>
<body>

    <div id="leaderboard">
        <h3>üèÜ Top Winners</h3>
        <div id="lb-content">No wins yet...</div>
        <button onclick="clearScore()" style="font-size:10px; margin-top:10px; background:red; border:none; color:white; cursor:pointer;">Reset Data</button>
    </div>

    <div id="top-ui">
        <h1 class="neon-text">FLAG BATTLE LIVE</h1>
        <div id="counter">50</div>
        <button class="btn" onclick="location.reload()">Next Round üîÑ</button>
    </div>

    <div id="ticker-box">
        <div id="ticker-header">ALIVE IN RING</div>
        <ul id="ticker-list"></ul>
    </div>

    <div id="winner-screen">
        <div id="winner-emoji"></div>
        <div id="winner-text"></div>
        <button class="btn" onclick="location.reload()">PLAY AGAIN</button>
    </div>

    <div id="canvas-container"></div>

    <script>
        // --- SETUP PHYSICS ---
        const Engine = Matter.Engine, Render = Matter.Render, Runner = Matter.Runner,
              Bodies = Matter.Bodies, Composite = Matter.Composite, Events = Matter.Events, Body = Matter.Body;

        const engine = Engine.create();
        const world = engine.world;
        engine.gravity.y = 1; // Normal gravity

        const width = window.innerWidth;
        const height = window.innerHeight;

        const render = Render.create({
            element: document.getElementById('canvas-container'),
            engine: engine,
            options: { width: width, height: height, wireframes: false, background: 'transparent' }
        });

        // --- GAME CONFIG ---
        const ringRadius = Math.min(width, height) * 0.36;
        const ballSize = Math.max(16, ringRadius / 14);
        // Country Name Map for Display
        const countryData = [
            {code:"IN", name:"India", emoji:"üáÆüá≥"}, {code:"US", name:"USA", emoji:"üá∫üá∏"},
            {code:"GB", name:"UK", emoji:"üá¨üáß"}, {code:"CA", name:"Canada", emoji:"üá®üá¶"},
            {code:"JP", name:"Japan", emoji:"üáØüáµ"}, {code:"BR", name:"Brazil", emoji:"üáßüá∑"},
            {code:"DE", name:"Germany", emoji:"üá©üá™"}, {code:"FR", name:"France", emoji:"üá´üá∑"},
            {code:"IT", name:"Italy", emoji:"üáÆüáπ"}, {code:"RU", name:"Russia", emoji:"üá∑üá∫"},
            {code:"AU", name:"Australia", emoji:"üá¶üá∫"}, {code:"CN", name:"China", emoji:"üá®üá≥"},
            {code:"KR", name:"S. Korea", emoji:"üá∞üá∑"}, {code:"ES", name:"Spain", emoji:"üá™üá∏"},
            {code:"MX", name:"Mexico", emoji:"üá≤üáΩ"}, {code:"ID", name:"Indonesia", emoji:"üáÆüá©"},
            {code:"TR", name:"Turkey", emoji:"üáπüá∑"}, {code:"SA", name:"Saudi", emoji:"üá∏üá¶"},
            {code:"ZA", name:"S. Africa", emoji:"üáøüá¶"}, {code:"EG", name:"Egypt", emoji:"üá™üá¨"},
            {code:"AR", name:"Argentina", emoji:"üá¶üá∑"}, {code:"NG", name:"Nigeria", emoji:"üá≥üá¨"},
            {code:"PK", name:"Pakistan", emoji:"üáµüá∞"}, {code:"BD", name:"Bangladesh", emoji:"üáßüá©"},
            {code:"VN", name:"Vietnam", emoji:"üáªüá≥"}, {code:"PH", name:"Philippines", emoji:"üáµüá≠"},
            {code:"TH", name:"Thailand", emoji:"üáπüá≠"}, {code:"IR", name:"Iran", emoji:"üáÆüá∑"},
            {code:"CO", name:"Colombia", emoji:"üá®üá¥"}, {code:"PL", name:"Poland", emoji:"üáµüá±"},
            {code:"UA", name:"Ukraine", emoji:"üá∫üá¶"}, {code:"MY", name:"Malaysia", emoji:"üá≤üáæ"},
            {code:"NL", name:"Netherlands", emoji:"üá≥üá±"}, {code:"BE", name:"Belgium", emoji:"üáßüá™"},
            {code:"SE", name:"Sweden", emoji:"üá∏üá™"}, {code:"CH", name:"Swiss", emoji:"üá®üá≠"},
            {code:"AT", name:"Austria", emoji:"üá¶üáπ"}, {code:"PT", name:"Portugal", emoji:"üáµüáπ"},
            {code:"GR", name:"Greece", emoji:"üá¨üá∑"}, {code:"IL", name:"Israel", emoji:"üáÆüá±"},
            {code:"SG", name:"Singapore", emoji:"üá∏üá¨"}, {code:"NZ", name:"New Zealand", emoji:"üá≥üáø"},
            {code:"IE", name:"Ireland", emoji:"üáÆüá™"}, {code:"DK", name:"Denmark", emoji:"üá©üá∞"},
            {code:"FI", name:"Finland", emoji:"üá´üáÆ"}, {code:"NO", name:"Norway", emoji:"üá≥üá¥"},
            {code:"CZ", name:"Czech", emoji:"üá®üáø"}, {code:"HU", name:"Hungary", emoji:"üá≠üá∫"},
            {code:"AE", name:"UAE", emoji:"üá¶üá™"}, {code:"QA", name:"Qatar", emoji:"üá∂üá¶"}
        ];

        // --- AUDIO SYSTEM (Crazy Sounds) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'hit') {
                // High pitch 'bonk'
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.exponentialRampToValueAtTime(600, now + 0.1);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } 
            else if (type === 'out') {
                // Cartoonish Fall 'Weuuu'
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.5);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.start(now); osc.stop(now + 0.5);
            }
            else if (type === 'win') {
                // Victory Fanfare
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(440, now);
                osc.frequency.setValueAtTime(554, now + 0.1); // C#
                osc.frequency.setValueAtTime(659, now + 0.2); // E
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0, now + 1.0);
                osc.start(now); osc.stop(now + 1.0);
            }
        }

        // --- LEADERBOARD LOGIC (LocalStorage) ---
        function updateLeaderboard(winnerName) {
            let data = JSON.parse(localStorage.getItem('flagWins') || '{}');
            if(winnerName) {
                data[winnerName] = (data[winnerName] || 0) + 1;
                localStorage.setItem('flagWins', JSON.stringify(data));
            }
            
            // Sort and Display
            const sorted = Object.entries(data).sort((a,b) => b[1] - a[1]).slice(0, 10);
            const html = sorted.map(([name, score], i) => 
                `<div class="lb-item"><span>#${i+1} ${name}</span><span class="lb-score">${score} üèÜ</span></div>`
            ).join('');
            document.getElementById('lb-content').innerHTML = html || "Play to win!";
        }
        function clearScore() { localStorage.removeItem('flagWins'); updateLeaderboard(); }
        updateLeaderboard(null); // Init load

        // --- TICKER LOGIC ---
        function updateTicker(balls) {
            const list = document.getElementById('ticker-list');
            list.innerHTML = "";
            balls.forEach(b => {
                const li = document.createElement('li');
                li.className = 'ticker-item';
                li.innerText = `${b.data.emoji} ${b.data.name}`;
                list.appendChild(li);
            });
        }

        // --- BUILD RING ---
        const segments = 40;
        const gapSize = 5; // Wide Gap
        const parts = [];
        for (let i = 0; i < segments; i++) {
            if (i < gapSize) continue; 
            const angle = i * (Math.PI * 2) / segments;
            const x = width/2 + Math.cos(angle) * ringRadius;
            const y = height/2 + Math.sin(angle) * ringRadius;
            parts.push(Bodies.rectangle(x, y, 50, 15, { 
                isStatic: true, angle: angle + Math.PI/2, render: { visible: false } 
            }));
        }
        const ring = Body.create({ parts: parts, isStatic: true });
        Composite.add(world, ring);

        // --- SPAWN BALLS ---
        const flags = [];
        countryData.forEach(c => {
            const ball = Bodies.circle(width/2 + (Math.random()-0.5)*100, height/2 + (Math.random()-0.5)*100, ballSize, {
                restitution: 0.8, friction: 0.005, label: 'ball'
            });
            ball.data = c;
            flags.push(ball);
        });
        Composite.add(world, flags);
        updateTicker(flags);

        // --- RENDER LOOP ---
        Events.on(render, 'afterRender', function() {
            const ctx = render.context;
            
            // Draw NEON RING
            ctx.shadowBlur = 15; ctx.shadowColor = "#00ffea"; ctx.fillStyle = "#fff";
            ring.parts.forEach(p => {
                if (p.label === 'Body') return;
                ctx.save(); ctx.translate(p.position.x, p.position.y); ctx.rotate(p.angle);
                ctx.fillRect(-25, -7.5, 50, 15);
                ctx.restore();
            });
            ctx.shadowBlur = 0; // Reset

            // Draw FLAGS
            ctx.font = `${ballSize * 1.6}px Arial`;
            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            flags.forEach(b => {
                ctx.save(); ctx.translate(b.position.x, b.position.y); ctx.rotate(b.angle);
                // Background circle
                ctx.beginPath(); ctx.arc(0,0, ballSize, 0, Math.PI*2);
                ctx.fillStyle = "rgba(255,255,255,0.8)"; ctx.fill();
                // Emoji
                ctx.fillStyle = "black"; ctx.fillText(b.data.emoji, 0, 2);
                ctx.restore();
            });
        });

        // --- UPDATE LOOP ---
        let gameActive = true;
        Events.on(engine, 'beforeUpdate', function() {
            if (!gameActive) return;

            // Rotate Ring
            Body.rotate(ring, 0.025);

            // Eliminations
            for (let i = flags.length - 1; i >= 0; i--) {
                const b = flags[i];
                // Check if fallen far
                if (b.position.y > height + 100 || 
                    Math.hypot(b.position.x - width/2, b.position.y - height/2) > ringRadius * 1.8) {
                    
                    Composite.remove(world, b);
                    flags.splice(i, 1);
                    playSound('out');
                    
                    // Update UI
                    document.getElementById('counter').innerText = flags.length;
                    updateTicker(flags);

                    // Win Check
                    if (flags.length === 1) {
                        gameActive = false;
                        const winner = flags[0];
                        playSound('win');
                        
                        // Show Screen
                        const screen = document.getElementById('winner-screen');
                        screen.style.display = 'flex';
                        document.getElementById('winner-emoji').innerText = winner.data.emoji;
                        document.getElementById('winner-text').innerText = winner.data.name + " WINS!";
                        
                        // Save Win
                        updateLeaderboard(winner.data.name);
                    }
                }
            }
        });

        // Collision Sounds
        Events.on(engine, 'collisionStart', e => {
            e.pairs.forEach(p => { if (p.bodyA.speed > 8 || p.bodyB.speed > 8) playSound('hit'); });
        });

        // Init
        Render.run(render);
        const runner = Runner.create();
        Runner.run(runner, engine);
        window.addEventListener('resize', () => location.reload());

    </script>
</body>
</html>
