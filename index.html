<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flag Battle: Stream Control</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        /* --- SPACE BACKGROUND --- */
        body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; color: white; user-select: none; }
        .stars, .twinkling { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: block; }
        .stars { background: #000 url('https://s3-us-west-2.amazonaws.com/s.cdpn.io/1231630/stars.png') repeat top center; z-index: 0; }
        .twinkling { background: transparent url('https://s3-us-west-2.amazonaws.com/s.cdpn.io/1231630/twinkling.png') repeat top center; z-index: 1; animation: move-twink-back 200s linear infinite; opacity: 0.5; }
        @keyframes move-twink-back { from {background-position:0 0;} to {background-position:-10000px 5000px;} }

        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; }

        /* --- UI DESIGN --- */
        .ui-box {
            background: rgba(0, 10, 20, 0.85);
            border: 2px solid #00d2ff;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 0 15px rgba(0, 210, 255, 0.2);
            pointer-events: auto;
            backdrop-filter: blur(5px);
        }

        /* TOP CENTER COUNTER */
        #top-ui { position: absolute; top: 10px; width: 100%; text-align: center; pointer-events: none; z-index: 20; }
        h1 { margin: 0; font-size: 22px; color: #fff; text-shadow: 0 0 10px #00d2ff; letter-spacing: 2px; opacity: 0.8; }
        #counter { font-size: 48px; font-weight: 900; color: #ff0055; text-shadow: 2px 2px 0 #fff; margin-top: 0px; }

        /* LEFT: LEADERBOARD */
        #leaderboard { 
            position: absolute; top: 20px; left: 20px; 
            width: 170px; height: 250px; overflow: hidden; 
            z-index: 20; border-color: #ffd700;
        }
        #leaderboard h3 { color: #ffd700; margin: 0 0 5px 0; border-bottom: 1px solid rgba(255,255,255,0.3); text-align: center; font-size: 14px; }
        #lb-list { list-style: none; padding: 0; margin: 0; animation: scrollUp 15s linear infinite; }
        .lb-item { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 2px;}
        .lb-score { color: #ffd700; font-weight: bold; }

        /* RIGHT: TICKER */
        #ticker-box {
            position: absolute; top: 20px; right: 20px; 
            width: 170px; height: 250px; overflow: hidden; z-index: 20; border-color: #ff0055;
        }
        #ticker-header { color: #ff0055; font-weight: bold; text-align: center; font-size: 14px; margin-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.3); }
        #ticker-list { list-style: none; padding: 0; margin: 0; text-align: center; animation: scrollUp 20s linear infinite; }
        .ticker-item { font-size: 13px; padding: 3px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }

        @keyframes scrollUp { 0% { transform: translateY(0); } 100% { transform: translateY(-100%); } }

        /* WINNER SCREEN */
        #winner-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); display: none;
            flex-direction: column; justify-content: center; align-items: center; z-index: 100;
            text-align: center;
        }
        .anim-text { animation: pop 0.5s infinite alternate; }
        @keyframes pop { from { transform: scale(1); } to { transform: scale(1.1); } }
        
        #winner-emoji { font-size: 120px; margin-bottom: 10px; }
        #winner-text { font-size: 50px; color: gold; margin: 0; text-shadow: 0 0 20px gold; text-transform: uppercase;}
        
        #countdown-box { margin-top: 30px; }
        #timer-text { font-size: 40px; color: #00ffea; font-weight: bold; font-family: monospace; }
        #cta-text { font-size: 20px; color: #fff; margin-top: 10px; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* --- SETTINGS MENU --- */
        #settings-btn {
            position: absolute; bottom: 20px; right: 20px;
            width: 50px; height: 50px;
            background: rgba(0,0,0,0.7); border: 2px solid #fff; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; z-index: 200; font-size: 24px; transition: transform 0.3s;
        }
        #settings-btn:hover { transform: rotate(90deg); background: #333; }

        #settings-modal {
            position: absolute; bottom: 80px; right: 20px;
            width: 250px; background: rgba(0, 10, 20, 0.95);
            border: 2px solid #00d2ff; border-radius: 10px;
            padding: 15px; display: none; flex-direction: column; gap: 10px;
            z-index: 200; box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        .control-group { display: flex; flex-direction: column; gap: 5px; }
        .control-label { font-size: 12px; color: #00d2ff; font-weight: bold; }
        input[type=range] { width: 100%; cursor: pointer; }
        
        .action-btn {
            background: #ff0055; color: white; border: none; padding: 10px;
            border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 5px;
        }
        .action-btn:hover { background: #ff3377; }
        .close-settings { text-align: right; color: #aaa; cursor: pointer; font-size: 12px; }

    </style>
</head>
<body>

    <div class="stars"></div>
    <div class="twinkling"></div>

    <div id="settings-btn" onclick="toggleSettings()">‚öôÔ∏è</div>

    <div id="settings-modal">
        <div class="close-settings" onclick="toggleSettings()">Close ‚úñ</div>
        
        <div class="control-group">
            <label class="control-label">Ring Speed</label>
            <input type="range" id="speed-ring" min="1" max="10" value="3">
        </div>

        <div class="control-group">
            <label class="control-label">Flag Bounce (Chaos)</label>
            <input type="range" id="speed-chaos" min="1" max="10" value="3">
        </div>

        <button class="action-btn" onclick="resetLeaderboard()">üóëÔ∏è RESET WINNERS</button>
    </div>

    <div id="leaderboard" class="ui-box">
        <h3>üèÜ TOTAL WINS</h3>
        <div style="overflow:hidden; height:210px; position:relative;">
            <div id="lb-list">Loading...</div>
        </div>
    </div>

    <div id="top-ui">
        <h1>BATTLE ROYALE</h1>
        <div id="counter">50</div>
    </div>

    <div id="ticker-box" class="ui-box">
        <div id="ticker-header">SURVIVORS</div>
        <div style="overflow:hidden; height:210px; position:relative;">
            <ul id="ticker-list"></ul>
        </div>
    </div>

    <div id="winner-screen">
        <div id="winner-emoji" class="anim-text"></div>
        <h1 id="winner-text"></h1>
        <div id="countdown-box">
            <div id="timer-text">NEXT: 10s</div>
            <div id="cta-text">üëá Comment Your Flag for LUCK! üçÄ</div>
        </div>
    </div>

    <div id="canvas-container"></div>

    <script>
        // --- SETTINGS VARIABLES ---
        let currentRingSpeed = 0.025; // Default
        let currentChaos = 0.002;     // Default

        function toggleSettings() {
            const el = document.getElementById('settings-modal');
            el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
        }

        // --- PHYSICS SETUP ---
        const Engine = Matter.Engine, Render = Matter.Render, Runner = Matter.Runner,
              Bodies = Matter.Bodies, Composite = Matter.Composite, Events = Matter.Events, Body = Matter.Body;

        const engine = Engine.create();
        const world = engine.world;
        engine.gravity.y = 1.0; 

        const width = window.innerWidth;
        const height = window.innerHeight;

        const render = Render.create({
            element: document.getElementById('canvas-container'),
            engine: engine,
            options: { width: width, height: height, wireframes: false, background: 'transparent' }
        });

        // --- INPUT LISTENERS (Live Updates) ---
        document.getElementById('speed-ring').addEventListener('input', (e) => {
            // Map 1-10 slider to 0.005 - 0.08 speed
            const val = parseInt(e.target.value);
            currentRingSpeed = 0.005 + (val * 0.007);
        });

        document.getElementById('speed-chaos').addEventListener('input', (e) => {
            // Map 1-10 slider to 0.0005 - 0.006 force
            const val = parseInt(e.target.value);
            currentChaos = 0.0005 + (val * 0.0006);
        });

        function resetLeaderboard() {
            if(confirm("Are you sure you want to delete all win records?")) {
                localStorage.removeItem('flagWins');
                updateLeaderboard(null);
                toggleSettings(); // Close menu
            }
        }

        // --- DATA ---
        const countryData = [
            {code:"IN", name:"India", emoji:"üáÆüá≥"}, {code:"US", name:"USA", emoji:"üá∫üá∏"}, {code:"GB", name:"UK", emoji:"üá¨üáß"}, 
            {code:"CA", name:"Canada", emoji:"üá®üá¶"}, {code:"JP", name:"Japan", emoji:"üáØüáµ"}, {code:"BR", name:"Brazil", emoji:"üáßüá∑"},
            {code:"DE", name:"Germany", emoji:"üá©üá™"}, {code:"FR", name:"France", emoji:"üá´üá∑"}, {code:"IT", name:"Italy", emoji:"üáÆüáπ"}, 
            {code:"RU", name:"Russia", emoji:"üá∑üá∫"}, {code:"AU", name:"Australia", emoji:"üá¶üá∫"}, {code:"CN", name:"China", emoji:"üá®üá≥"},
            {code:"KR", name:"Korea", emoji:"üá∞üá∑"}, {code:"ES", name:"Spain", emoji:"üá™üá∏"}, {code:"MX", name:"Mexico", emoji:"üá≤üáΩ"}, 
            {code:"ID", name:"Indonesia", emoji:"üáÆüá©"}, {code:"TR", name:"Turkey", emoji:"üáπüá∑"}, {code:"SA", name:"Saudi", emoji:"üá∏üá¶"},
            {code:"ZA", name:"S. Africa", emoji:"üáøüá¶"}, {code:"EG", name:"Egypt", emoji:"üá™üá¨"}, {code:"AR", name:"Argentina", emoji:"üá¶üá∑"}, 
            {code:"NG", name:"Nigeria", emoji:"üá≥üá¨"}, {code:"PK", name:"Pakistan", emoji:"üáµüá∞"}, {code:"BD", name:"Bangladesh", emoji:"üáßüá©"},
            {code:"VN", name:"Vietnam", emoji:"üáªüá≥"}, {code:"PH", name:"Philippines", emoji:"üáµüá≠"}, {code:"TH", name:"Thailand", emoji:"üáπüá≠"}, 
            {code:"IR", name:"Iran", emoji:"üáÆüá∑"}, {code:"CO", name:"Colombia", emoji:"üá®üá¥"}, {code:"PL", name:"Poland", emoji:"üáµüá±"},
            {code:"UA", name:"Ukraine", emoji:"üá∫üá¶"}, {code:"MY", name:"Malaysia", emoji:"üá≤üáæ"}, {code:"NL", name:"Neth.", emoji:"üá≥üá±"}, 
            {code:"BE", name:"Belgium", emoji:"üáßüá™"}, {code:"SE", name:"Sweden", emoji:"üá∏üá™"}, {code:"CH", name:"Swiss", emoji:"üá®üá≠"},
            {code:"AT", name:"Austria", emoji:"üá¶üáπ"}, {code:"PT", name:"Portugal", emoji:"üáµüáπ"}, {code:"GR", name:"Greece", emoji:"üá¨üá∑"}, 
            {code:"IL", name:"Israel", emoji:"üáÆüá±"}, {code:"SG", name:"Singapore", emoji:"üá∏üá¨"}, {code:"NZ", name:"NZ", emoji:"üá≥üáø"},
            {code:"IE", name:"Ireland", emoji:"üáÆüá™"}, {code:"DK", name:"Denmark", emoji:"üá©üá∞"}, {code:"FI", name:"Finland", emoji:"üá´üáÆ"}, 
            {code:"NO", name:"Norway", emoji:"üá≥üá¥"}, {code:"CZ", name:"Czech", emoji:"üá®üáø"}, {code:"HU", name:"Hungary", emoji:"üá≠üá∫"},
            {code:"AE", name:"UAE", emoji:"üá¶üá™"}, {code:"QA", name:"Qatar", emoji:"üá∂üá¶"}
        ];

        // --- UI UPDATES ---
        function updateLeaderboard(winnerName) {
            let data = JSON.parse(localStorage.getItem('flagWins') || '{}');
            if(winnerName) { data[winnerName] = (data[winnerName] || 0) + 1; localStorage.setItem('flagWins', JSON.stringify(data)); }
            
            const sorted = Object.entries(data).sort((a,b) => b[1] - a[1]);
            document.getElementById('lb-list').innerHTML = sorted.map(([n,s],i)=> 
                `<div class="lb-item"><span>${i+1}. ${n}</span><span class="lb-score">${s}</span></div>`
            ).join('') || "<div style='text-align:center'>No Data</div>";
        }
        updateLeaderboard(null);

        function updateTicker(balls) {
            const list = document.getElementById('ticker-list');
            list.innerHTML = "";
            balls.forEach(b => {
                const li = document.createElement('li');
                li.className = 'ticker-item';
                li.innerText = `${b.data.emoji} ${b.data.name}`;
                list.appendChild(li);
            });
        }

        // --- WORLD ---
        const floor = Bodies.rectangle(width/2, height + 60, width, 100, { isStatic: true, render:{visible:false} });
        const leftWall = Bodies.rectangle(-50, height, 100, height, { isStatic: true });
        const rightWall = Bodies.rectangle(width+50, height, 100, height, { isStatic: true });
        Composite.add(world, [floor, leftWall, rightWall]);

        const ringRadius = Math.min(width, height) * 0.35;
        const ringY = height * 0.45;
        const segments = 45; 
        const gapSize = 4;
        const ringParts = [];
        for (let i = 0; i < segments; i++) {
            if (i < gapSize) continue;
            const angle = i * (Math.PI * 2) / segments;
            const x = width/2 + Math.cos(angle) * ringRadius;
            const y = ringY + Math.sin(angle) * ringRadius;
            ringParts.push(Bodies.rectangle(x, y, 45, 15, { isStatic: true, angle: angle + Math.PI/2, render: { visible: false } }));
        }
        const ring = Body.create({ parts: ringParts, isStatic: true });
        Composite.add(world, ring);

        const ballSize = Math.max(16, ringRadius / 14);
        let activeFlags = [];
        let eliminatedFlags = []; 

        countryData.forEach(c => {
            const ball = Bodies.circle(width/2 + (Math.random()-0.5)*50, ringY + (Math.random()-0.5)*50, ballSize, {
                restitution: 1.05, friction: 0.001, frictionAir: 0.002, label: 'ball'
            });
            ball.data = c;
            activeFlags.push(ball);
        });
        Composite.add(world, activeFlags);
        updateTicker(activeFlags);

        // --- RENDER ---
        Events.on(render, 'afterRender', function() {
            const ctx = render.context;
            ctx.shadowBlur = 15; ctx.shadowColor = "#00d2ff"; ctx.fillStyle = "#fff";
            ring.parts.forEach(p => {
                if (p.label==='Body') return;
                ctx.save(); ctx.translate(p.position.x, p.position.y); ctx.rotate(p.angle);
                ctx.fillRect(-22, -7.5, 44, 15);
                ctx.restore();
            });
            ctx.shadowBlur = 0;

            ctx.font = `${ballSize * 1.5}px Arial`;
            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            const drawFlag = (b, opacity) => {
                ctx.save(); ctx.translate(b.position.x, b.position.y); ctx.rotate(b.angle);
                ctx.beginPath(); ctx.arc(0,0, ballSize, 0, Math.PI*2);
                ctx.fillStyle = `rgba(255,255,255,${opacity})`; ctx.fill();
                ctx.fillStyle = "#000"; ctx.fillText(b.data.emoji, 0, 2);
                ctx.restore();
            };
            activeFlags.forEach(b => drawFlag(b, 0.9));
            eliminatedFlags.forEach(b => drawFlag(b, 0.5));
        });

        // --- GAME LOOP ---
        let gameActive = true;
        Events.on(engine, 'beforeUpdate', function() {
            if(!gameActive) return;

            // USE DYNAMIC SPEED VARIABLE
            Body.rotate(ring, currentRingSpeed);

            if (engine.timing.timestamp % 30 === 0) {
                activeFlags.forEach(b => {
                    if(Math.random() > 0.7) {
                        // USE DYNAMIC CHAOS VARIABLE
                        Body.applyForce(b, b.position, { 
                            x: (Math.random()-0.5) * currentChaos, 
                            y: (Math.random()-0.5) * currentChaos 
                        });
                    }
                });
            }

            for (let i = activeFlags.length - 1; i >= 0; i--) {
                const b = activeFlags[i];
                const dist = Math.hypot(b.position.x - width/2, b.position.y - ringY);
                
                if (dist > ringRadius * 1.5 || b.position.y > ringY + ringRadius + 50) {
                    activeFlags.splice(i, 1);
                    eliminatedFlags.push(b);
                    document.getElementById('counter').innerText = activeFlags.length;
                    updateTicker(activeFlags);
                    b.restitution = 0.5; b.friction = 0.5;

                    if (activeFlags.length === 1) {
                        gameActive = false;
                        const winner = activeFlags[0];
                        
                        const screen = document.getElementById('winner-screen');
                        screen.style.display = 'flex';
                        document.getElementById('winner-emoji').innerText = winner.data.emoji;
                        document.getElementById('winner-text').innerText = winner.data.name + " WINS!";
                        updateLeaderboard(winner.data.name);

                        let timeLeft = 10;
                        const timerText = document.getElementById('timer-text');
                        
                        const interval = setInterval(() => {
                            timeLeft--;
                            timerText.innerText = `NEXT: ${timeLeft}s`;
                            if (timeLeft <= 0) {
                                clearInterval(interval);
                                location.reload();
                            }
                        }, 1000);
                    }
                }
            }
        });

        Render.run(render);
        const runner = Runner.create();
        Runner.run(runner, engine);
        window.addEventListener('resize', () => location.reload());

    </script>
</body>
</html>
