<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chaos Flag Battle</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        /* --- SPACE BACKGROUND WITH MOVING STARS --- */
        body {
            margin: 0; padding: 0; overflow: hidden;
            background-color: #000;
            font-family: 'Segoe UI', sans-serif;
            color: white;
        }

        /* Stars Animation */
        .stars, .twinkling {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%; display: block;
        }
        .stars {
            background: #000 url('https://s3-us-west-2.amazonaws.com/s.cdpn.io/1231630/stars.png') repeat top center;
            z-index: 0;
        }
        .twinkling {
            background: transparent url('https://s3-us-west-2.amazonaws.com/s.cdpn.io/1231630/twinkling.png') repeat top center;
            z-index: 1;
            animation: move-twink-back 200s linear infinite;
            opacity: 0.7;
        }
        @keyframes move-twink-back {
            from {background-position:0 0;}
            to {background-position:-10000px 5000px;}
        }

        #canvas-container { 
            position: absolute; top: 0; left: 0;
            width: 100vw; height: 100vh; 
            display: flex; justify-content: center; align-items: center; 
            z-index: 5;
        }

        /* --- UI ELEMENTS --- */
        #top-ui {
            position: absolute; top: 20px; width: 100%; text-align: center; pointer-events: none; z-index: 10;
        }
        h1 { margin: 0; font-size: 28px; letter-spacing: 2px; color: #fff; text-shadow: 0 0 10px #00d2ff; text-transform: uppercase; }
        #counter { font-size: 50px; font-weight: 800; color: #ff0055; text-shadow: 2px 2px 0px #fff; margin-top: 5px; }

        /* LEADERBOARD */
        #leaderboard {
            position: absolute; top: 20px; left: 20px;
            background: rgba(0, 20, 40, 0.7);
            border: 1px solid #00d2ff;
            border-radius: 8px;
            padding: 10px;
            width: 180px;
            max-height: 40vh;
            overflow-y: auto;
            z-index: 20;
            pointer-events: auto;
            box-shadow: 0 0 10px rgba(0, 210, 255, 0.2);
        }
        #leaderboard h3 { margin: 0 0 5px 0; font-size: 16px; color: #ffd700; border-bottom: 1px solid #555; }
        .lb-item { font-size: 12px; display: flex; justify-content: space-between; margin-bottom: 4px; }

        /* SURVIVOR TICKER */
        #ticker-box {
            position: absolute; top: 20px; right: 20px; width: 200px;
            background: rgba(0, 20, 40, 0.7);
            border: 1px solid #ff0055;
            border-radius: 8px;
            padding: 10px;
            height: 50vh;
            overflow: hidden;
            z-index: 20;
        }
        #ticker-header { color: #ff0055; font-weight: bold; text-align: center; font-size: 14px; margin-bottom: 5px; border-bottom: 1px solid #555; }
        #ticker-list { list-style: none; padding: 0; margin: 0; text-align: center; }
        .ticker-item { font-size: 13px; padding: 3px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }

        /* BUTTON */
        .btn {
            pointer-events: auto; margin-top: 10px; padding: 8px 20px;
            background: #00d2ff; color: #000; font-weight: bold; border: none; border-radius: 20px; cursor: pointer;
            box-shadow: 0 0 15px #00d2ff;
        }
        
        /* WINNER SCREEN */
        #winner-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none;
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 100;
        }
    </style>
</head>
<body>

    <div class="stars"></div>
    <div class="twinkling"></div>

    <div id="leaderboard">
        <h3>üèÜ Top Winners</h3>
        <div id="lb-content">No wins yet...</div>
        <button onclick="localStorage.removeItem('flagWins'); updateLeaderboard(null);" style="margin-top:5px; font-size:10px; cursor:pointer;">Reset</button>
    </div>

    <div id="top-ui">
        <h1>BATTLE ROYALE</h1>
        <div id="counter">50</div>
        <button class="btn" onclick="location.reload()">RESTART MATCH</button>
    </div>

    <div id="ticker-box">
        <div id="ticker-header">SURVIVORS</div>
        <ul id="ticker-list"></ul>
    </div>

    <div id="winner-screen">
        <div id="winner-emoji" style="font-size:100px;"></div>
        <h1 id="winner-text" style="font-size:60px; color:gold; text-shadow:0 0 20px gold;"></h1>
        <button class="btn" onclick="location.reload()">PLAY AGAIN</button>
    </div>

    <div id="canvas-container"></div>

    <script>
        const Engine = Matter.Engine, Render = Matter.Render, Runner = Matter.Runner,
              Bodies = Matter.Bodies, Composite = Matter.Composite, Events = Matter.Events, Body = Matter.Body;

        // Create Engine with slightly higher gravity to pull them down, 
        // but we will add "turbulence" later to make them bounce.
        const engine = Engine.create();
        const world = engine.world;
        engine.gravity.y = 1.2; 

        const width = window.innerWidth;
        const height = window.innerHeight;

        const render = Render.create({
            element: document.getElementById('canvas-container'),
            engine: engine,
            options: { width: width, height: height, wireframes: false, background: 'transparent' }
        });

        // --- CONFIG ---
        const ringRadius = Math.min(width, height) * 0.38;
        const ballSize = Math.max(18, ringRadius / 15);
        
        // Country Data
        const countryData = [
            {code:"IN", name:"India", emoji:"üáÆüá≥"}, {code:"US", name:"USA", emoji:"üá∫üá∏"},
            {code:"GB", name:"UK", emoji:"üá¨üáß"}, {code:"CA", name:"Canada", emoji:"üá®üá¶"},
            {code:"JP", name:"Japan", emoji:"üáØüáµ"}, {code:"BR", name:"Brazil", emoji:"üáßüá∑"},
            {code:"DE", name:"Germany", emoji:"üá©üá™"}, {code:"FR", name:"France", emoji:"üá´üá∑"},
            {code:"IT", name:"Italy", emoji:"üáÆüáπ"}, {code:"RU", name:"Russia", emoji:"üá∑üá∫"},
            {code:"AU", name:"Australia", emoji:"üá¶üá∫"}, {code:"CN", name:"China", emoji:"üá®üá≥"},
            {code:"KR", name:"Korea", emoji:"üá∞üá∑"}, {code:"ES", name:"Spain", emoji:"üá™üá∏"},
            {code:"MX", name:"Mexico", emoji:"üá≤üáΩ"}, {code:"ID", name:"Indonesia", emoji:"üáÆüá©"},
            {code:"TR", name:"Turkey", emoji:"üáπüá∑"}, {code:"SA", name:"Saudi", emoji:"üá∏üá¶"},
            {code:"ZA", name:"S. Africa", emoji:"üáøüá¶"}, {code:"EG", name:"Egypt", emoji:"üá™üá¨"},
            {code:"AR", name:"Argentina", emoji:"üá¶üá∑"}, {code:"NG", name:"Nigeria", emoji:"üá≥üá¨"},
            {code:"PK", name:"Pakistan", emoji:"üáµüá∞"}, {code:"BD", name:"Bangladesh", emoji:"üáßüá©"},
            {code:"VN", name:"Vietnam", emoji:"üáªüá≥"}, {code:"PH", name:"Philippines", emoji:"üáµüá≠"},
            {code:"TH", name:"Thailand", emoji:"üáπüá≠"}, {code:"IR", name:"Iran", emoji:"üáÆüá∑"},
            {code:"CO", name:"Colombia", emoji:"üá®üá¥"}, {code:"PL", name:"Poland", emoji:"üáµüá±"},
            {code:"UA", name:"Ukraine", emoji:"üá∫üá¶"}, {code:"MY", name:"Malaysia", emoji:"üá≤üáæ"},
            {code:"NL", name:"Neth.", emoji:"üá≥üá±"}, {code:"BE", name:"Belgium", emoji:"üáßüá™"},
            {code:"SE", name:"Sweden", emoji:"üá∏üá™"}, {code:"CH", name:"Swiss", emoji:"üá®üá≠"},
            {code:"AT", name:"Austria", emoji:"üá¶üáπ"}, {code:"PT", name:"Portugal", emoji:"üáµüáπ"},
            {code:"GR", name:"Greece", emoji:"üá¨üá∑"}, {code:"IL", name:"Israel", emoji:"üáÆüá±"},
            {code:"SG", name:"Singapore", emoji:"üá∏üá¨"}, {code:"NZ", name:"NZ", emoji:"üá≥üáø"},
            {code:"IE", name:"Ireland", emoji:"üáÆüá™"}, {code:"DK", name:"Denmark", emoji:"üá©üá∞"},
            {code:"FI", name:"Finland", emoji:"üá´üáÆ"}, {code:"NO", name:"Norway", emoji:"üá≥üá¥"},
            {code:"CZ", name:"Czech", emoji:"üá®üáø"}, {code:"HU", name:"Hungary", emoji:"üá≠üá∫"},
            {code:"AE", name:"UAE", emoji:"üá¶üá™"}, {code:"QA", name:"Qatar", emoji:"üá∂üá¶"}
        ];

        // --- SOUNDS ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'hit') {
                osc.frequency.setValueAtTime(200 + Math.random()*200, now);
                osc.frequency.exponentialRampToValueAtTime(50, now+0.1);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.linearRampToValueAtTime(0, now+0.1);
                osc.start(now); osc.stop(now+0.1);
            } else if (type === 'out') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(100, now+0.4);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now+0.4);
                osc.start(now); osc.stop(now+0.4);
            }
        }

        // --- LEADERBOARD & TICKER ---
        function updateLeaderboard(winnerName) {
            let data = JSON.parse(localStorage.getItem('flagWins') || '{}');
            if(winnerName) {
                data[winnerName] = (data[winnerName] || 0) + 1;
                localStorage.setItem('flagWins', JSON.stringify(data));
            }
            const sorted = Object.entries(data).sort((a,b) => b[1] - a[1]).slice(0, 10);
            document.getElementById('lb-content').innerHTML = sorted.map(([n,s],i)=>
                `<div class="lb-item"><span>#${i+1} ${n}</span><span>${s}</span></div>`
            ).join('') || "No Data";
        }
        updateLeaderboard(null);

        function updateTicker(arr) {
            const list = document.getElementById('ticker-list');
            list.innerHTML = "";
            arr.forEach(b => {
                const li = document.createElement('li');
                li.className = 'ticker-item';
                li.innerText = `${b.data.emoji} ${b.data.name}`;
                list.appendChild(li);
            });
        }

        // --- RING GENERATION (SMALL GAP FIX) ---
        const segments = 50; 
        const gapSize = 3; // Reduced from 5 to 3 for tighter game!
        const parts = [];
        for (let i = 0; i < segments; i++) {
            if (i < gapSize) continue;
            const angle = i * (Math.PI * 2) / segments;
            const x = width/2 + Math.cos(angle) * ringRadius;
            const y = height/2 + Math.sin(angle) * ringRadius;
            parts.push(Bodies.rectangle(x, y, 40, 15, { 
                isStatic: true, 
                angle: angle + Math.PI/2,
                render: { visible: false },
                restitution: 1.0 // Wall bounce!
            }));
        }
        const ring = Body.create({ parts: parts, isStatic: true });
        Composite.add(world, ring);

        // --- SPAWN FLAGS (BOUNCY) ---
        const flags = [];
        countryData.forEach(c => {
            const ball = Bodies.circle(width/2 + (Math.random()-0.5)*50, height/2 + (Math.random()-0.5)*50, ballSize, {
                restitution: 0.95, // VERY BOUNCY (Superball style)
                friction: 0.002,   // Slippery
                frictionAir: 0.005, // Little air resistance
                label: 'ball'
            });
            ball.data = c;
            flags.push(ball);
        });
        Composite.add(world, flags);
        updateTicker(flags);

        // --- RENDER LOOP ---
        Events.on(render, 'afterRender', function() {
            const ctx = render.context;
            
            // Neon Ring Glow
            ctx.shadowBlur = 20; ctx.shadowColor = "#00d2ff"; ctx.fillStyle = "#fff";
            ring.parts.forEach(p => {
                if (p.label==='Body') return;
                ctx.save(); ctx.translate(p.position.x, p.position.y); ctx.rotate(p.angle);
                ctx.fillRect(-20, -7.5, 40, 15);
                ctx.restore();
            });
            ctx.shadowBlur = 0;

            // Flags
            ctx.font = `${ballSize * 1.5}px Arial`;
            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            flags.forEach(b => {
                ctx.save(); ctx.translate(b.position.x, b.position.y); ctx.rotate(b.angle);
                ctx.beginPath(); ctx.arc(0,0, ballSize, 0, Math.PI*2);
                ctx.fillStyle = "rgba(255,255,255,0.9)"; ctx.fill();
                ctx.fillStyle = "#000"; ctx.fillText(b.data.emoji, 0, 2);
                ctx.restore();
            });
        });

        // --- GAME LOGIC & CHAOS ---
        let gameActive = true;
        Events.on(engine, 'beforeUpdate', function() {
            if(!gameActive) return;

            // 1. Rotate Ring
            Body.rotate(ring, 0.02);

            // 2. CHAOS MODE: Randomly kick balls to keep them moving
            if (engine.timing.timestamp % 20 === 0) { // Every few frames
                flags.forEach(b => {
                    // Small random impulse
                    if(Math.random() > 0.8) {
                        Body.applyForce(b, b.position, {
                            x: (Math.random() - 0.5) * 0.005,
                            y: (Math.random() - 0.5) * 0.005
                        });
                    }
                });
            }

            // 3. Check Deaths
            for (let i = flags.length - 1; i >= 0; i--) {
                const b = flags[i];
                if (b.position.y > height + 100 || 
                    Math.hypot(b.position.x - width/2, b.position.y - height/2) > ringRadius * 1.6) {
                    
                    Composite.remove(world, b);
                    flags.splice(i, 1);
                    playSound('out');
                    document.getElementById('counter').innerText = flags.length;
                    updateTicker(flags);

                    if (flags.length === 1) {
                        gameActive = false;
                        const winner = flags[0];
                        document.getElementById('winner-screen').style.display = 'flex';
                        document.getElementById('winner-emoji').innerText = winner.data.emoji;
                        document.getElementById('winner-text').innerText = winner.data.name + " WINS!";
                        updateLeaderboard(winner.data.name);
                    }
                }
            }
        });

        Events.on(engine, 'collisionStart', e => {
            e.pairs.forEach(p => { 
                // Play sound if speed is decent
                if (p.bodyA.speed > 5 || p.bodyB.speed > 5) playSound('hit'); 
            });
        });

        Render.run(render);
        const runner = Runner.create();
        Runner.run(runner, engine);
        window.addEventListener('resize', () => location.reload());

    </script>
</body>
</html>
