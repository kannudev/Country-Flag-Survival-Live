<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flag Battle: Pile Up</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        /* --- SPACE BACKGROUND --- */
        body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; color: white; }
        .stars, .twinkling { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: block; }
        .stars { background: #000 url('https://s3-us-west-2.amazonaws.com/s.cdpn.io/1231630/stars.png') repeat top center; z-index: 0; }
        .twinkling { background: transparent url('https://s3-us-west-2.amazonaws.com/s.cdpn.io/1231630/twinkling.png') repeat top center; z-index: 1; animation: move-twink-back 200s linear infinite; opacity: 0.5; }
        @keyframes move-twink-back { from {background-position:0 0;} to {background-position:-10000px 5000px;} }

        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; }

        /* --- UI DESIGN --- */
        .ui-box {
            background: rgba(0, 15, 30, 0.85);
            border: 2px solid #00d2ff;
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 0 15px rgba(0, 210, 255, 0.3);
            pointer-events: auto;
        }

        /* TOP CENTER */
        #top-ui { position: absolute; top: 10px; width: 100%; text-align: center; pointer-events: none; z-index: 20; }
        h1 { margin: 0; font-size: 24px; color: #fff; text-shadow: 0 0 10px #00d2ff; letter-spacing: 1px; }
        #counter { font-size: 42px; font-weight: 900; color: #ff0055; text-shadow: 2px 2px 0 #fff; margin-top: 5px; }
        .btn { pointer-events: auto; background: #00d2ff; color: #000; border: none; padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; margin-top: 5px; }

        /* LEFT: LEADERBOARD */
        #leaderboard { position: absolute; top: 20px; left: 20px; width: 160px; max-height: 250px; overflow-y: auto; z-index: 20; font-size: 12px; }
        #leaderboard h3 { color: #ffd700; margin: 0 0 5px 0; border-bottom: 1px solid #555; text-align: center; }
        .lb-item { display: flex; justify-content: space-between; margin-bottom: 3px; }

        /* RIGHT: COMPACT TICKER (Fixed Problem) */
        #ticker-box {
            position: absolute; top: 20px; right: 20px; 
            width: 180px; 
            height: 200px; /* Fixed Height - No Overlap */
            overflow: hidden; /* Hide extra list */
            z-index: 20;
            border-color: #ff0055;
        }
        #ticker-header { color: #ff0055; font-weight: bold; text-align: center; font-size: 14px; margin-bottom: 5px; border-bottom: 1px solid #555; }
        
        /* Scrolling Animation for List */
        #ticker-list { list-style: none; padding: 0; margin: 0; text-align: center; animation: scrollUp 20s linear infinite; }
        .ticker-item { font-size: 14px; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        @keyframes scrollUp { 
            0% { transform: translateY(0); } 
            100% { transform: translateY(-100%); } 
        }

        /* WINNER SCREEN */
        #winner-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none;
            flex-direction: column; justify-content: center; align-items: center; z-index: 100;
        }
        .anim-text { animation: pop 0.5s infinite alternate; }
        @keyframes pop { from { transform: scale(1); } to { transform: scale(1.1); } }
    </style>
</head>
<body>

    <div class="stars"></div>
    <div class="twinkling"></div>

    <div id="leaderboard" class="ui-box">
        <h3>üèÜ Wins</h3>
        <div id="lb-content">Loading...</div>
        <div style="text-align:center; margin-top:5px;">
            <button onclick="localStorage.removeItem('flagWins'); updateLeaderboard(null);" style="font-size:10px; cursor:pointer; background:red; color:white; border:none; border-radius:4px;">Reset</button>
        </div>
    </div>

    <div id="top-ui">
        <h1>BATTLE ROYALE</h1>
        <div id="counter">50</div>
        <button class="btn" onclick="location.reload()">RESTART</button>
    </div>

    <div id="ticker-box" class="ui-box">
        <div id="ticker-header">SURVIVORS</div>
        <div style="overflow:hidden; height:160px; position:relative;">
            <ul id="ticker-list"></ul>
        </div>
    </div>

    <div id="winner-screen">
        <div id="winner-emoji" style="font-size:120px;" class="anim-text"></div>
        <h1 id="winner-text" style="font-size:60px; color:gold; margin:10px;"></h1>
        <button class="btn" style="font-size:20px; padding:15px 40px;" onclick="location.reload()">PLAY AGAIN</button>
    </div>

    <div id="canvas-container"></div>

    <script>
        const Engine = Matter.Engine, Render = Matter.Render, Runner = Matter.Runner,
              Bodies = Matter.Bodies, Composite = Matter.Composite, Events = Matter.Events, Body = Matter.Body;

        const engine = Engine.create();
        const world = engine.world;
        engine.gravity.y = 1.0; 

        const width = window.innerWidth;
        const height = window.innerHeight;

        const render = Render.create({
            element: document.getElementById('canvas-container'),
            engine: engine,
            options: { width: width, height: height, wireframes: false, background: 'transparent' }
        });

        // --- GAME DATA ---
        const countryData = [
            {code:"IN", name:"India", emoji:"üáÆüá≥"}, {code:"US", name:"USA", emoji:"üá∫üá∏"}, {code:"GB", name:"UK", emoji:"üá¨üáß"}, 
            {code:"CA", name:"Canada", emoji:"üá®üá¶"}, {code:"JP", name:"Japan", emoji:"üáØüáµ"}, {code:"BR", name:"Brazil", emoji:"üáßüá∑"},
            {code:"DE", name:"Germany", emoji:"üá©üá™"}, {code:"FR", name:"France", emoji:"üá´üá∑"}, {code:"IT", name:"Italy", emoji:"üáÆüáπ"}, 
            {code:"RU", name:"Russia", emoji:"üá∑üá∫"}, {code:"AU", name:"Australia", emoji:"üá¶üá∫"}, {code:"CN", name:"China", emoji:"üá®üá≥"},
            {code:"KR", name:"Korea", emoji:"üá∞üá∑"}, {code:"ES", name:"Spain", emoji:"üá™üá∏"}, {code:"MX", name:"Mexico", emoji:"üá≤üáΩ"}, 
            {code:"ID", name:"Indonesia", emoji:"üáÆüá©"}, {code:"TR", name:"Turkey", emoji:"üáπüá∑"}, {code:"SA", name:"Saudi", emoji:"üá∏üá¶"},
            {code:"ZA", name:"S. Africa", emoji:"üáøüá¶"}, {code:"EG", name:"Egypt", emoji:"üá™üá¨"}, {code:"AR", name:"Argentina", emoji:"üá¶üá∑"}, 
            {code:"NG", name:"Nigeria", emoji:"üá≥üá¨"}, {code:"PK", name:"Pakistan", emoji:"üáµüá∞"}, {code:"BD", name:"Bangladesh", emoji:"üáßüá©"},
            {code:"VN", name:"Vietnam", emoji:"üáªüá≥"}, {code:"PH", name:"Philippines", emoji:"üáµüá≠"}, {code:"TH", name:"Thailand", emoji:"üáπüá≠"}, 
            {code:"IR", name:"Iran", emoji:"üáÆüá∑"}, {code:"CO", name:"Colombia", emoji:"üá®üá¥"}, {code:"PL", name:"Poland", emoji:"üáµüá±"},
            {code:"UA", name:"Ukraine", emoji:"üá∫üá¶"}, {code:"MY", name:"Malaysia", emoji:"üá≤üáæ"}, {code:"NL", name:"Neth.", emoji:"üá≥üá±"}, 
            {code:"BE", name:"Belgium", emoji:"üáßüá™"}, {code:"SE", name:"Sweden", emoji:"üá∏üá™"}, {code:"CH", name:"Swiss", emoji:"üá®üá≠"},
            {code:"AT", name:"Austria", emoji:"üá¶üáπ"}, {code:"PT", name:"Portugal", emoji:"üáµüáπ"}, {code:"GR", name:"Greece", emoji:"üá¨üá∑"}, 
            {code:"IL", name:"Israel", emoji:"üáÆüá±"}, {code:"SG", name:"Singapore", emoji:"üá∏üá¨"}, {code:"NZ", name:"NZ", emoji:"üá≥üáø"},
            {code:"IE", name:"Ireland", emoji:"üáÆüá™"}, {code:"DK", name:"Denmark", emoji:"üá©üá∞"}, {code:"FI", name:"Finland", emoji:"üá´üáÆ"}, 
            {code:"NO", name:"Norway", emoji:"üá≥üá¥"}, {code:"CZ", name:"Czech", emoji:"üá®üáø"}, {code:"HU", name:"Hungary", emoji:"üá≠üá∫"},
            {code:"AE", name:"UAE", emoji:"üá¶üá™"}, {code:"QA", name:"Qatar", emoji:"üá∂üá¶"}
        ];

        // --- SOUNDS ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            
            if (type === 'hit') {
                osc.frequency.setValueAtTime(300 + Math.random()*200, now);
                osc.frequency.exponentialRampToValueAtTime(50, now+0.1);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.1);
                osc.start(now); osc.stop(now+0.1);
            } else if (type === 'out') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(100, now+0.3);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.3);
                osc.start(now); osc.stop(now+0.3);
            }
        }

        // --- UI UPDATES ---
        function updateLeaderboard(winnerName) {
            let data = JSON.parse(localStorage.getItem('flagWins') || '{}');
            if(winnerName) { data[winnerName] = (data[winnerName] || 0) + 1; localStorage.setItem('flagWins', JSON.stringify(data)); }
            const sorted = Object.entries(data).sort((a,b) => b[1] - a[1]).slice(0, 8);
            document.getElementById('lb-content').innerHTML = sorted.map(([n,s],i)=> `<div class="lb-item"><span>#${i+1} ${n}</span><span>${s}</span></div>`).join('') || "No Data";
        }
        updateLeaderboard(null);

        function updateTicker(balls) {
            // Only show active balls
            const list = document.getElementById('ticker-list');
            list.innerHTML = "";
            balls.forEach(b => {
                const li = document.createElement('li');
                li.className = 'ticker-item';
                li.innerText = `${b.data.emoji} ${b.data.name}`;
                list.appendChild(li);
            });
        }

        // --- PHYSICS WORLD SETUP ---
        
        // 1. FLOOR & WALLS (To keep piles on screen)
        const floor = Bodies.rectangle(width/2, height + 60, width, 100, { isStatic: true, render:{visible:false} });
        const leftWall = Bodies.rectangle(-50, height, 100, height, { isStatic: true });
        const rightWall = Bodies.rectangle(width+50, height, 100, height, { isStatic: true });
        Composite.add(world, [floor, leftWall, rightWall]);

        // 2. ROTATING RING (Centered, higher up)
        const ringRadius = Math.min(width, height) * 0.35;
        const ringY = height * 0.45; // Move ring slightly UP so pile fits below
        const segments = 45; 
        const gapSize = 4;
        const ringParts = [];
        
        for (let i = 0; i < segments; i++) {
            if (i < gapSize) continue;
            const angle = i * (Math.PI * 2) / segments;
            const x = width/2 + Math.cos(angle) * ringRadius;
            const y = ringY + Math.sin(angle) * ringRadius;
            ringParts.push(Bodies.rectangle(x, y, 45, 15, { 
                isStatic: true, angle: angle + Math.PI/2, render: { visible: false } 
            }));
        }
        const ring = Body.create({ parts: ringParts, isStatic: true });
        Composite.add(world, ring);

        // 3. SPAWN FLAGS
        const ballSize = Math.max(16, ringRadius / 14);
        let activeFlags = [];
        let eliminatedFlags = []; // Track who fell out

        countryData.forEach(c => {
            const ball = Bodies.circle(width/2 + (Math.random()-0.5)*50, ringY + (Math.random()-0.5)*50, ballSize, {
                restitution: 1.05, // EXTRA BOUNCY
                friction: 0.001,
                frictionAir: 0.002, // Less air resistance = more movement
                label: 'ball'
            });
            ball.data = c;
            activeFlags.push(ball);
        });
        Composite.add(world, activeFlags);
        updateTicker(activeFlags);

        // --- RENDER & GAME LOOP ---
        Events.on(render, 'afterRender', function() {
            const ctx = render.context;
            
            // Draw NEON RING
            ctx.shadowBlur = 15; ctx.shadowColor = "#00d2ff"; ctx.fillStyle = "#fff";
            ring.parts.forEach(p => {
                if (p.label==='Body') return;
                ctx.save(); ctx.translate(p.position.x, p.position.y); ctx.rotate(p.angle);
                ctx.fillRect(-22, -7.5, 44, 15);
                ctx.restore();
            });
            ctx.shadowBlur = 0;

            // Draw ALL Flags (Active + Eliminated)
            ctx.font = `${ballSize * 1.5}px Arial`;
            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            
            const drawFlag = (b, opacity) => {
                ctx.save(); ctx.translate(b.position.x, b.position.y); ctx.rotate(b.angle);
                ctx.beginPath(); ctx.arc(0,0, ballSize, 0, Math.PI*2);
                ctx.fillStyle = `rgba(255,255,255,${opacity})`; ctx.fill();
                ctx.fillStyle = "#000"; ctx.fillText(b.data.emoji, 0, 2);
                ctx.restore();
            };

            activeFlags.forEach(b => drawFlag(b, 0.9));
            eliminatedFlags.forEach(b => drawFlag(b, 0.5)); // Dimmer for fallen
        });

        // --- UPDATE LOGIC ---
        let gameActive = true;
        Events.on(engine, 'beforeUpdate', function() {
            if(!gameActive) return;

            // Rotate Ring
            Body.rotate(ring, 0.025);

            // CHAOS: Random impulses to active flags
            if (engine.timing.timestamp % 30 === 0) {
                activeFlags.forEach(b => {
                    if(Math.random() > 0.7) {
                        Body.applyForce(b, b.position, { x: (Math.random()-0.5)*0.002, y: (Math.random()-0.5)*0.002 });
                    }
                });
            }

            // CHECK FALLOUT
            for (let i = activeFlags.length - 1; i >= 0; i--) {
                const b = activeFlags[i];
                const dist = Math.hypot(b.position.x - width/2, b.position.y - ringY);
                
                // If flag falls out of ring area
                if (dist > ringRadius * 1.5 || b.position.y > ringY + ringRadius + 50) {
                    
                    // 1. Move from Active -> Eliminated
                    activeFlags.splice(i, 1);
                    eliminatedFlags.push(b);

                    // 2. Play Sound
                    playSound('out');

                    // 3. Update UI
                    document.getElementById('counter').innerText = activeFlags.length;
                    updateTicker(activeFlags);

                    // 4. IMPORTANT: Don't remove body! Let it hit the floor.
                    // Reduce bounciness for fallen flags so they settle
                    b.restitution = 0.5;
                    b.friction = 0.5;

                    // WIN CONDITION
                    if (activeFlags.length === 1) {
                        gameActive = false;
                        const winner = activeFlags[0];
                        document.getElementById('winner-screen').style.display = 'flex';
                        document.getElementById('winner-emoji').innerText = winner.data.emoji;
                        document.getElementById('winner-text').innerText = winner.data.name + " WINS!";
                        updateLeaderboard(winner.data.name);
                    }
                }
            }
        });

        Events.on(engine, 'collisionStart', e => {
            e.pairs.forEach(p => { 
                // Only sound for active balls hitting fast
                if (p.bodyA.speed > 6 || p.bodyB.speed > 6) playSound('hit'); 
            });
        });

        Render.run(render);
        const runner = Runner.create();
        Runner.run(runner, engine);
        window.addEventListener('resize', () => location.reload());

    </script>
</body>
</html>
